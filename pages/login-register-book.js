import Axios from "axios";
import Head from "next/head";
import Image from "next/image";
import { useState, useEffect } from "react";
import styles from "../styles/Home.module.css";
import * as CONSTANTS from "./../utils/constants";

export default function Home() {
  const [login, setlogin] = useState({ email: "", password: "" });

  const [registerUser, setRegisterUser] = useState({ email: "", password: "" });

  const [ticketInfo, setTicketInfo] = useState([
    { name: "", isChild: true, gender: null },
  ]);

  const [ticketDate, setTicketDate] = useState("");

  const [isLogged, setIsLogged] = useState(false);
  const [refreshToken, setRefreshToken] = useState(0);

  const changeTicketData = (e, index, type) => {
    let copy = [...ticketInfo];

    if (type === "age") {
      copy[index].isChild = !copy[index].isChild;
    }
    if (type === "name") {
      copy[index].name = e.target.value;
    }
    if (type === "gender") {
      copy[index].gender = e.target.value;
    }

    setTicketInfo(copy);
  };

  useEffect(() => {
    let intervalid = setInterval(async () => {
      try {
        let userId = localStorage.getItem("userId");
        let token = localStorage.getItem("token");
        let refresh = await Axios.post("/api/refresh", { userId, token });

        if (refresh.data.token) {
          localStorage.setItem("token", refresh.data.token);
          setRefreshToken(refreshToken + 1);
          setIsLogged(true);
        } else {
          setIsLogged(false);
        }

        let tickets = await Axios.post("/api/account", { userId, token });
      } catch (err) {
        setIsLogged(false);
        console.log(err);
      }
    }, 5000);

    return () => {
      clearInterval(intervalid);
    };
  }, [refreshToken]);

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div>
        <input
          type={"text"}
          name="name"
          value={registerUser.name}
          placeholder="name"
          onChange={(e) =>
            setRegisterUser({
              ...registerUser,
              [e.target.name]: e.target.value,
            })
          }
        />
        <input
          type={"email"}
          name="email"
          value={registerUser.email}
          placeholder="email"
          onChange={(e) =>
            setRegisterUser({
              ...registerUser,
              [e.target.name]: e.target.value,
            })
          }
        />
        <br />
        <input
          type={"password"}
          name="password"
          placeholder="password"
          onChange={(e) =>
            setRegisterUser({
              ...registerUser,
              [e.target.name]: e.target.value,
            })
          }
        />
        <br />
        <button
          onClick={async () => {
            const user = await Axios.post("/api/user", registerUser);
            localStorage.setItem("userId", user.data.id);
          }}
        >
          Register
        </button>
      </div>

      <br />
      <br />
      <br />

      <div>
        <h1>{isLogged ? "you are found" : "can't find you"}</h1>
        <input
          type={"email"}
          name="email"
          placeholder="email"
          onChange={(e) =>
            setlogin({ ...login, [e.target.name]: e.target.value })
          }
        />
        <br />
        <input
          type={"password"}
          name="password"
          placeholder="password"
          onChange={(e) =>
            setlogin({ ...login, [e.target.name]: e.target.value })
          }
        />
        <br />
        <button
          onClick={async () => {
            const user = await Axios.post("/api/login", login);
            console.log(user.data);
            if (user.data.userId && user.data.token) {
              localStorage.setItem("userId", user.data.userId);
              localStorage.setItem("token", user.data.token);
            }
          }}
        >
          Login
        </button>
      </div>

      <br />
      <br />
      <br />

      <div>
        <label htmlFor="ticketDate">Ticket Date:</label>
        <input
          type="date"
          id="ticketDate"
          name="ticketDate"
          onChange={(e) => setTicketDate(e.target.value)}
        />
        <br />
        <br />
        <button
          onClick={() => {
            let copy = [...ticketInfo];
            copy.push({ name: "", isChild: true, gender: null });
            setTicketInfo(copy);
          }}
        >
          add
        </button>

        {ticketInfo?.map((ticket, index) => {
          return (
            <div key={index}>
              <input
                type={"text"}
                name="name"
                value={ticket.name}
                placeholder="name"
                onChange={(e) => changeTicketData(e, index, "name")}
              />
              <div className="radio">
                <label>
                  <input
                    type="radio"
                    value="Male"
                    checked={ticket.gender === "Male"}
                    onChange={(e) => {
                      changeTicketData(e, index, "gender");
                    }}
                  />
                  Male
                </label>
              </div>
              <div className="radio">
                <label>
                  <input
                    type="radio"
                    value="Female"
                    checked={ticket.gender === "Female"}
                    onChange={(e) => {
                      changeTicketData(e, index, "gender");
                    }}
                  />
                  Female
                </label>
              </div>
              <div className="radio">
                <label>
                  <input
                    type="radio"
                    value="Other"
                    checked={ticket.gender === "Other"}
                    onChange={(e) => {
                      changeTicketData(e, index, "gender");
                    }}
                  />
                  Other
                </label>
              </div>
              <input
                type={"checkbox"}
                label="is Child"
                checked={ticket.isChild}
                onChange={(e) => {
                  console.log("clicked to change the age", e);
                  changeTicketData(e, index, "age");
                }}
              />{" "}
              is Child
              <button
                onClick={() => {
                  let copy = [...ticketInfo];
                  copy.splice(index, 1);
                  setTicketInfo(copy);
                }}
              >
                delete me
              </button>
            </div>
          );
        })}
        <br></br>
        <button
          onClick={async () => {
            if (!isLogged) {
              alert("PLEASE LOG IN");
            } else {
              let userId = localStorage.getItem("userId");
              let token = localStorage.getItem("token");
              const ticket = await Axios.post("/api/ticket", {
                date: ticketDate,
                info: ticketInfo,
                userId,
                token,
              });
              console.log(ticket.data);
              if (ticket.data) {
              }
            }
          }}
        >
          BOOK TICKET
        </button>
      </div>
      <img
        src="data:image/png;base64,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"
        alt=""
        width="260"
      />
    </div>
  );
}
